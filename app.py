import streamlit as st
import pandas as pd
from model import run_prediction
import matplotlib.pyplot as plt # –í–∞–∂–Ω–æ: –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∏—Ä–æ–∫—É—é –∫–æ–º–ø–æ–Ω–æ–≤–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã Streamlit
st.set_page_config(layout="wide")
st.title("üí° –ü—Ä–µ–¥–∏–∫—Ç–∏–≤–Ω–æ–µ –¢–û —Å–∏—Å—Ç–µ–º—ã ECS Airbus A320")

st.markdown("üì§ –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –¥–∞–Ω–Ω—ã—Ö `ecs_data.xlsx` (—Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Å–∏—Å—Ç–µ–º—ã ECS).")

# –í–∏–¥–∂–µ—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
uploaded_file = st.file_uploader("–í—ã–±–µ—Ä–∏—Ç–µ Excel-—Ñ–∞–π–ª", type=["xlsx"])

# –ï—Å–ª–∏ —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω
if uploaded_file:
    try:
        df = pd.read_excel(uploaded_file)
        st.success("‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω")

        # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
        if st.button("üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ"):
            # –û—á–∏—â–∞–µ–º –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≥—Ä–∞—Ñ–∏–∫–∏ –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º –∑–∞–ø—É—Å–∫–æ–º, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∏—Ö –Ω–∞–ª–æ–∂–µ–Ω–∏—è
            plt.close('all') 
            
            # –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ run_prediction –∏–∑ model.py.
            # ***–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–ë–ï–î–ò–¢–ï–°–¨, –ß–¢–û –≠–¢–û–¢ –ü–û–†–Ø–î–û–ö –†–ê–°–ü–ê–ö–û–í–ö–ò –¢–û–ß–ù–û –°–û–û–¢–í–ï–¢–°–¢–í–£–ï–¢
            # –ü–û–†–Ø–î–ö–£ –í–û–ó–í–†–ê–¢–ê –ó–ù–ê–ß–ï–ù–ò–ô –í –§–£–ù–ö–¶–ò–ò run_prediction –í model.py.***
            # model.py –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç: df, fig_roc, fig_temp, fig_dtemp, status, fig_shap (6 –∑–Ω–∞—á–µ–Ω–∏–π)
            result_df, fig_roc, fig_temp, fig_dtemp, status, fig_shap = run_prediction(df)

            st.subheader("üìã –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ:")
            st.info(status) # –ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ DataFrame —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –Ω–µ –ø—É—Å—Ç–æ–π.
            # –ï—Å–ª–∏ –æ–Ω –ø—É—Å—Ç–æ–π, –∑–Ω–∞—á–∏—Ç, –≤ model.py –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫–æ–ª–æ–Ω–∫–∏),
            # –∏ `status` —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –≥—Ä–∞—Ñ–∏–∫–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º.
            if not result_df.empty: 
                st.subheader("üìä ROC-–∫—Ä–∏–≤–∞—è")
                st.pyplot(fig_roc) # –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≥—Ä–∞—Ñ–∏–∫ fig_roc

                st.subheader("üí° –í–∞–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ (SHAP Values)") 
                st.pyplot(fig_shap) # –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≥—Ä–∞—Ñ–∏–∫ fig_shap

                st.subheader("üå° –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ PACK —Å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–º–∏ –æ—Ç–∫–∞–∑–∞–º–∏")
                st.pyplot(fig_temp) # –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≥—Ä–∞—Ñ–∏–∫ fig_temp

                st.subheader("üìà –ü—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã PACK (dTemp) —Å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–º–∏ –æ—Ç–∫–∞–∑–∞–º–∏")
                st.pyplot(fig_dtemp) # –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≥—Ä–∞—Ñ–∏–∫ fig_dtemp

                # –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞
                st.download_button(
                    "üì• –°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞",
                    result_df.to_csv(index=False).encode('utf-8'),
                    file_name="ecs_prediction_result.csv"
                )
            # else: –ï—Å–ª–∏ result_df –ø—É—Å—Ç–æ–π (–∏–∑-–∑–∞ –æ—à–∏–±–æ–∫ –≤ model.py),
            #       —Ç–æ —Å—Ç–∞—Ç—É—Å —É–∂–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ st.info(status),
            #       –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –∑–¥–µ—Å—å –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

    except Exception as e:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—â–∏—Ö –æ—à–∏–±–æ–∫ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ –∏–ª–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞–±–æ—Ç—ã
        st.error(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: {e}")
        st.warning("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª `ecs_data.xlsx` –∏–º–µ–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏.")
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—â–∏—Ö –æ—à–∏–±–æ–∫ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ –∏–ª–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞–±–æ—Ç—ã
        st.error(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: {e}")
        st.warning("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª `ecs_data.xlsx` –∏–º–µ–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏.")

